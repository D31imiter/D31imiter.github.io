## 组成与架构

由流量传感器，文件威胁鉴定器，分析平台，天擎四个模块组成

### 流量传感器

#### 仪表盘：

状态监听：设备连接状态、设备列表、资源占用、系统信息、授权信息、攻击规则信息、威胁情报信息、网络流量、应用流
量、数据采集、会话监控、文件类型统计、日志外发统计

#### 威胁告警

展示网页漏洞利用、webshell上传、网络攻击、威胁情报4种类型的所有告警（威胁告警->详情->解码小助手，提供对各种编码内容进行转义）

#### 规则配置

网页漏洞利用，webshell上传，网络攻击，自定义规则包含漏洞规则、威胁情报，威胁情报支持导入导出，

* 导出格式：导出情报文件的格式，可选OPENIOC、JSON、STIX三种格式，支持多选，选择多种格式则以压缩包形式导出，解压后可查看文件；
* 导出状态：选择需要导出情报的状态，“全部”、“全部启用”、“全部停用”只能选择一种，选择“全部”则导出所有情报，选择“全部启
  用”则导出启用状态为启用的所有情报，选择“全部停用”则导出启用状态为停用的所有情报。

#### 策略配置

* 威胁检测：提供了威胁检测开关的启停功能，及高级参数、弱口令、内部资产IP的配置功能
* 流量记录：（启用流量负载记录）控制向分析平台发送数据中是否带payload数据及携带的上下行数据长度；（启用流
  量过滤）提供网络流量筛选功能；（自定义协议）支持用户根据端口配置协议信息
* 文件还原：用于配置管理文件还原功能，支持启停文件还原功能，并支持配置还原的协议类型、文件类型及文件大小（最大值）。支持在
  （系统管理->联动管理->数据传输设置）页面配置传输规则，将还原的文件外发给文件威胁鉴定器
* 抓包检测：手动导入pcap包检测，系统会将分析出来的协议日志、告警日志发送分析平台，将产生的网页漏洞利用、webshell上传、网络攻击、威胁情报告警、恶意文件在威胁感知->告警列表页面进行展示，将还原出的文件和对应的流量日志发送文件威胁鉴定器
* 旁路阻断：其通过分析设备采集的流量数据包，再根据配置的阻断策略通过发rst报文或重定向的形式对满足条件的流量进行封禁操作，并统计阻断次数、记录阻断日志。支持配置管理阻断策略及封禁策略（人工规则）、阻断白名单信息。
* SSL解密：http流量经过SSL加密，就是https流量，而加密过程就是服务器使用SSL私钥进行加密。传感器在处理HTTPS流量时，首先会使用用户上传的私钥对相应的流量进行解密，将https流量转换为http流量，之后就是正常的流量处理流程（文件还原，告警等），同时向外发送日志。web界面上解密流量的私钥状态会变为绿色。
* 白名单配置：系统提供两大类白名单配置，配置规则与威胁情报白名单之后，命中白名单的告警不会入数据库存储，也不会进行展示和外发；配置文件白名单，命中文件MD5后不会进行检测。点击白名单类型下拉列表可以切换不同的类型

#### 系统管理

##### 基础配置

中包括系统证书配置、网络配置、时间配置、升级配置、运营配置、存储管理、系统维护、诊断工具、系统信息配置，配置完成后点击“保存”即可生效

##### 联动管理

* 数据传输设置：模块用于配置分析平台、文件威胁鉴定器、SYSLOG服务器、Hadoop平台、攻击诱捕系统5种平台的传输规则配置，同时提供了日志外发白名单功能，匹配白名单的日志将不再传输给其他平台
* SNMP管理：模块提供用户SNMP服务配置和SNMP Trap配置功能，用来对设备运行状态进行实时监测。管理员可通过SNMP客户端主动访问设备MIB库查询，也可通过配置SNMP Trap在客户端接收设备发出的Trap消息

##### 安全性配置

中包括登陆设置、数据传输加密、敏感操作密码、单点登录密钥配置

##### 账号管理

账号管理是系统维护人员保证系统安全的一项措施，以控制系统维护人员对系统的使用、防止系统维护人员对系统的越权使用或误操作

##### 操作审计

模块主要用于对用户操作信息进行查询和导出。管理员可按照开始时间、结束时间、用户、登录IP、功能、操作类型等信息进行条件查询

### 天眼分析平台

#### 检测中心

##### 仪表盘

仪表板默认统计了 8 个维度的数据，包括告警统计、攻击者统计、受害主机统计、系统维护、文件威胁鉴定器、邮件威胁
检测系统、网神云锁和自定义视图

##### 系统运行监控

全景图形式展现分析平台联动的设备信息

##### 监测工作台

监测工作台支持用户自定义配置重点监测数据到工作台，方便用户统一查看并使用重点关注的系统功能模块信息。包含：

重点监测：失陷主机、外部攻击、横向攻击、越权访 问、弱口令、挖矿行为、暴力破解、补天漏洞。

威胁感知：告警列表，威胁情报，web 安 全，数据库安全，中间件安全，未授权行为，设备安全，攻击者视角和资产视角。

分析中 心：DNS 服务分析，非常规服务分析，邮件行为分析，登录分析，web服务器行为分析， 数据库行为分析，访问行为分析。

资产感知：资产管理，资产发现，资产互访，脆弱性， 配置核查。系统配置：证书配置，设备监控

##### 态势感知

#### 威胁感知

威胁感知》告警列表》接入的告警来源为流量传感器、文件威胁鉴定器、邮件威胁检 测系统、服务器安全管理系统（云锁）、
攻击诱捕系统、智慧管理分析系统（SMAC）、 SOAR 自动化编排场景和全部。

自定义检索场景支持置顶、重命名、删除检索场景、保存+另存为检索场景

#### 分析中心

##### 日志检索

日志检索支持快捷模式、高级模式、专家模式

##### 行为分析

行为分析包括 DNS 服务分析、非常规服务分析、邮件行为分析、登录行为分析、 WEB 服务器行为分析、数据库行为分析和访问行为
分析七大模块，每个部分包含对应 的分析场景，基本涵盖行为分析的业务场景。行为分析覆盖场景丰富，根据多种威胁类 型全面检测用户
环境的异常行为。

其中 DNS 服务分析包含了子场景可疑 DNS 解析、 DNS 服务器发现、链路劫持分析、DNS 重绑定分析；

非常规服务分析包含了子场景可疑代理、远程工具、反弹 shell；登录行为分析包含了子场景暴力破解、异常登录、特权账号登录、弱口令、明文密码泄露；

WEB 服务行为分析包括非常用请求方法发现、 可疑爬虫或扫描、后门上传利用；

访问行为分析包括外部访问、横向访问、内部主机外联、风险端口访问

#### 响应处置

#### 资产感知

#### 报告报表

#### 重保

重保演习主要为了护网事件所设定，用户可以自定义护网任务，根据用户所选择的资产组进 行重点关注。

护网任务一共包含三个阶段：备战阶段、实战阶段、战后任务列表。
【自定义黑 IP】可通过本地录入和离线导入两 种方式导入黑 IP。其中本地录入支持手动添加黑 IP 和从本地批量上传黑 IP 两种方式。
离线导入方式数据导出和离线导入两种操作。若未安装或激活黑 IP 插件，点击【导出统计数据】按钮，则 会跳转至扩展程序配置页面；若已
安装并激活黑 IP 插件，点击【导出统计数据】按钮，则跳转至 【扩展程序】->【告警分析】页面

### 文件威胁鉴定器

行为：主机行为：文件、注册表、进程、互斥体、服务等		网络行为：外链域名、外链主机等

异常检测：异常开启、异常关闭、检测沙箱环境等相关行为

策略：针对大数据引擎及沙箱评估进行综合打分策略设定；并在此基础上设置处置策略支持威胁情报匹配

多文件来源：流量还原，目录服务器（FTP&SMB)，手动提交，API接口

沙箱：支持4套环境（包括WIN XP,WIN7;搭载Office 03/07等环境）

环境：灵活的流程控制，可基于策略进行样本归档、静态-动态检测流程自定义

检测能力：云查杀引擎，数字签名检测，QEX脚本查杀引擎，启发式引擎，QVM人工智能引擎，系统文件智能修复引擎，安卓文件检测引擎，BitDefender检测引擎，模拟文件真实运行，分析文件行为

#### 进程监控

#### 状态监控

#### 文件告警

#### 提交检测

本地提交，URL文件提交

FTP文件提交：对应大于50M的文件不会拉取到沙箱进行处理通过zmq进行push操作。相同MD5 文件不重复提交

SMB文件提交

#### 样本查询

可输入时间范围（最多30天）和文件MD5值查询样本，点击操作栏按钮可跳转

#### 策略管理

检测策略，加白日志，处置策略，规则配置

#### 系统配置

* 常规配置：硬盘监控，系统时间（系统时间提供两种矫正方式：默认自动与时间服务器进行同步，设备会在每天的凌晨00:00进行时间同步 ；关闭自动同步后，用户可以手动更改系统时间和时区）
* 网络管理：代理服务器配置服务默认是关闭状态，开启后展示代理服务器服务相关配置选项
* 安全性设置：安全性配置模块包含登录设置和数据传输加密两部分。
  用户登录的安全配置，包含登录异常帐号锁定、登录密码强度要求、登录密码长度要求、页面登录超时时间、是否强制密码更换和首次登录更
  改密码；
  数据传输加密配置后可保证数据传输过程中的安全性，支持AES256和SM4，默认使用AES256，秘钥要求必须为6-32位字母和数字。保存后生效
* 用户管理：

  ```
    系统管理员权限：状态监控、文件报警、检测策略、审计日志、统计分析、系统配置
    操作管理员权限：状态监控、文件报警、检测策略、统计分析
    审计日志权限：审计日志
    admin为系统管理员，不允许删除，不允许被修改角色。
    用户名：32个字符以内；
    密码：8~16位；
    超时时间：1-60分钟以内
  ```
* 审计日志
* 证书管理
* 系统升级
* 系统维护
* 联动管理

  * syslog：SYSLOG管理主要提供syslog服务管理，通过开启syslog服务，在页面上配置syslog的传输方式、IP和端口，并设置需要联动的系统日志、告警日志、日志级别。实现较灵活的syslog联动管理
  * SNMP模块主要提供SNMP服务配置和SNMP Trap配置。SNMP服务默认是关闭状态，开启后展示SNMP服务相关配置选项；SNMP Trap开关默认是关闭状态，开启后展示SNMP Trap服务相关配置选项

## 日志检索

### 检索语法

##### 威胁告警检索字段

attack_sip： 攻击者IP

alarm_sip：受害者IP

attack_type： 攻击类型

is_web_attack： 用于标记告警是否是web告警，0:否，1:是

hazard_level： 威胁级别 威胁级别标识、取值：0-10

##### 网络协议字段

access_time： 日志生成时间，传感器采集到该数据包并解析完成生，成日志的时间戳
@timestamp： 时间戳 日志在分析平台存储入库时添加
sip： 源ip 网络数据流的发起IP
sport： 源端口 网络数据流的客户端应用端口
dip： 目的ip 网络数据流的服务端IP
dport： 目的端口 网络数据流的服务端应用端口
geo： ip对应的地理位置

##### TCP&UDP过滤

proto： 协议 IP包头中的协议字段值

uplink_length： 上行字节数，从TCP流的建立到该流的结束，从客户端发往服务器端的
应用层数据的字节总数

downlink_length： 下行字节数，从TCP流的建立到该流的结束，从服务器端发往客户端的
应用层数据的字节总数

src_mac： 源mac TCP 数据流客户端发往服务端的数据包，源MAC地址

dst_mac： 目的mac TCP 数据流客户端发往服务端的数据包，目的MAC地址

up_payload： 上行前100字节，从TCP流的建立起，从客户端发往服务器端应用层的前100
个字节

down_payload： 下行前100字，从TCP流的建立起，从服务器端发往客户端应用层的前100
个字

##### 其他http请求方式

CONNECT： HTTP/1.1 协议中预留给能够将连接改为管道方式的代理服务器。
OPTIONS：允许客户端查看服务器的性能。
TRACE： 回显服务器收到的请求，主要用于测试或诊断。
PATCH： 是对 PUT 方法的补充，用来对已知资源进行局部更新 。

##### HTTP协议字段

method： HTTP请求方法，HTTP包头的method字段，最常见：GET和POST
uri： 请求的资源 HTTP包头的URI字段
host： 请求的域名 HTTP包头的host字段
cookie： Cookie HTTP包头的cookie字段
agent： 请求者信息 HTTP包头的user-Agent字段
referer： 链接来源 HTTP包头的referer字段
xff： 请求端真实IP和代理 HTTP包头的xff字段（仅供参考）
data： 传送的数据，POST类型的报文，截取POST的部分原始数据，最多1000字

##### DNS协议字段

dns_type： DNS访问类型，表示是请求报文还是响应报文；0代表DNS请求；1代表DNS响应
host Host： 请求的域名信息
addr： 地址资源，DNS的A记录，表示该host对应的IP地址信息；可能有多个记录

##### SSL协议字段

version： 版本号 SSL的版本号
session_id： 会话id本次会话的session_id, server hello 报文中的session_id
server_name： 服务器名字
SSL： client_hello报文中的扩展字段 通过该字段判断客户端和哪个站点进行交互。
issuer_name： 每封证书中的颁发者的名字 每封证书中的颁发者的名字
notbefore： 该证书的有效期的起始时间 该证书的有效期的起始时间
notafter： 该证书的有效期的起始时间 该证书的有效期的起始时间
public_key： 该证书的公钥 该证书的公钥
user_name： Sever端的证书的持有者最上层证书的使用者，即本次SSL连接Sever端的
证书的持有者

##### 文件传输协议字段

proto： 协议 协议名称；FTP/SMB/HTTP
trans_mode： 传输模式 文件的传输模式；对于源ip来说，upload表示上传，download表示下载
file_name： 文件名字 无
file_md5： 文件md5 对于文件内容计算MD5
mime_type： 文件类型 文件类型
uri： 传输的资源及路径 HTTP包头的uri字段
host： 域名 HTTP包头的host字段
referer： 链接来源 HTTP包头的referer字段
status： 状态码 承载该文件的HTTP响应报文的返回码
file_dir： 标示文件方向 文件的传输方向；0 代表服务端传往客户端 ，1 代表客户端传往服务端
method： 方法 HTTP包头的Method字段
mime_type： 文件类型 文件类型

##### 登录协议字段

proto： 应用的协议登录行为数据流属于的应用协议；ftp, smb, oracle, mysql,mssql, postgresql, ssh, pop3, smtp
passwd： 登陆密码 登录使用的密码
info： 登陆结果登录操作的结果：成功或者失败，FTP协议会记录具体信息
user： 用户名 登录使用的用户名
db_type： 数据库类型 当登录的是数据库时，该字段会有数值，表示数据库具体类型；mssql，oracle，MySQL，postgresql四种
normal_ret： 登录或数据库操作结果的归一化展示 success，failed

##### 邮件查询字段

proto： 应用协议邮件使用的应用协议; pop3, smtp, imap,webmail
time： 邮件发送/接收时间 邮件包头中的邮件发送/接收时间
from： 邮件发送人 来自于邮件头相应字段
to： 邮件接收人 来自于邮件头相应字段
cc： 邮件抄送人 来自于邮件头相应字段
subject： 主题 来自于邮件头相应字段
references： 被当前邮件回复的邮件ID 来自于邮件头相应字段
attach_name： 附件名字 来自于邮件头相应字段
attach_md5： 附件md5 来自于邮件头相应字段
mime_type： 附件mime_type（字典库） 来自于邮件头相应字段
plain： 邮件正文 来自于邮件头相应字段

##### 数据库查询字段

proto： 数据库应用协议 根据报文中得到的协议字段转为可读的字符串；tds:mssql；tns:oracle；mysql:mysql；
postgresql：postgresql
version： 协议版本协议的版本号
user： 用户 报文提取
db_name： 数据库 报文提取
db_type: 数据库类型 mssql，oracle，mysql，postgresql四个值
ret_code： 数据库操作返回的状态信息 sql语句执行的结果，Success或具体的失败信息
sql_info： 操作信息 报文提取的sql语句
